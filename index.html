<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تتبع رحلة التوبة والتغيير</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #e0f2f7 0%, #cce7f5 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            padding: 45px;
            width: 100%;
            max-width: 850px;
            text-align: center;
            direction: rtl;
            position: relative;
            z-index: 10;
            overflow: hidden;
            animation: fadeInScale 0.8s ease-out forwards;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        input[type="number"], input[type="text"] {
            border: 2px solid #a7d9f7;
            border-radius: 12px;
            padding: 14px 20px;
            width: calc(100% - 40px);
            margin-bottom: 25px;
            font-size: 1.25rem;
            transition: border-color 0.4s ease, box-shadow 0.4s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: right; /* Align text to the right for Arabic input */
        }
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.2);
        }
        button {
            background-image: linear-gradient(45deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            position: relative;
            overflow: hidden;
            border: none;
        }
        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 25px rgba(76, 175, 80, 0.6);
        }
        button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            opacity: 0;
            transform: scale(1) translate(-50%, -50%);
            transition: width 0.5s ease-out, height 0.5s ease-out, opacity 0.5s ease-out;
        }
        button:active::after {
            width: 200%;
            height: 200%;
            opacity: 1;
            transition: 0s;
        }

        .info-section {
            background-color: #f0f8ff;
            border: 1px solid #b3e0ff;
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
            text-align: right;
            transition: all 0.5s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }
        .info-section.loaded {
            opacity: 1;
            transform: translateY(0);
        }
        .info-section h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #b3e0ff;
            padding-bottom: 12px;
        }
        .info-section p {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #5d748f;
        }
        .loading-spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 30px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.4s ease-out;
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 35px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            max-width: 450px;
            text-align: center;
            position: relative;
            transform: translateY(-30px) scale(0.9);
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            opacity: 0;
        }
        .modal.show .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal-content h3 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 700;
        }
        .modal-content p {
            font-size: 1.2rem;
            color: #5d748f;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .modal-content button {
            background-color: #ef5350;
            background-image: linear-gradient(45deg, #ef5350 0%, #e57370 100%);
            box-shadow: 0 4px 15px rgba(239, 83, 80, 0.3);
        }
        .modal-content button:hover {
            background-color: #e53935;
            box-shadow: 0 6px 20px rgba(239, 83, 80, 0.4);
        }

        /* AI Help Modal specific styles */
        #aiHelpModal .modal-content {
            max-width: 600px;
            text-align: right;
            min-height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        #aiHelpModal .modal-content h3 {
            text-align: center;
        }
        #aiHelpModal .advice-display {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            color: #1976d2;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.6;
            transition: all 0.3s ease-out;
            opacity: 0;
            transform: scale(0.95);
        }
        #aiHelpModal .advice-display.show-advice {
            opacity: 1;
            transform: scale(1);
        }
        #aiHelpModal .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        #aiHelpModal .button-group button {
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        #aiHelpModal #nextAdviceButton {
            background-image: linear-gradient(45deg, #2196F3 0%, #03A9F4 100%);
        }
        #aiHelpModal #nextAdviceButton:hover {
            background-image: linear-gradient(45deg, #1976D2 0%, #0288D1 100%);
            transform: translateY(-2px);
        }
        #aiHelpModal #revealAiChatButton {
            background-image: linear-gradient(45deg, #FFC107 0%, #FFEB3B 100%);
            color: #333;
        }
        #aiHelpModal #revealAiChatButton:hover {
            background-image: linear-gradient(45deg, #FFA000 0%, #FFC107 100%);
            color: #333;
            transform: translateY(-2px);
        }

        #aiHelpModal .ai-question-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        #aiHelpModal .ai-question-section.show {
            display: block;
            opacity: 1;
        }
        #aiHelpModal .ai-question-section textarea {
            width: 100%;
            border: 2px solid #a7d9f7;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        #aiHelpModal .ai-question-section textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        #aiHelpModal .ai-response {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: right;
            font-size: 1.1rem;
            color: #388e3c;
            line-height: 1.6;
        }
        #aiHelpModal .math-problem {
            font-size: 1.3rem;
            font-weight: bold;
            color: #0d47a1;
            margin-top: 10px;
            margin-bottom: 10px;
            background-color: #e0f7fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed #00bcd4;
        }
        #aiHelpModal .modal-close-button {
            background-image: linear-gradient(45deg, #ef5350 0%, #e57370 100%);
            margin-top: 25px;
            width: auto;
            padding: 12px 25px;
        }

        /* Commitment Modal specific styles */
        #commitmentSection .modal-content { /* Changed from .modal to #commitmentSection */
            max-width: 550px;
            text-align: center;
        }
        #commitmentSection .modal-content button {
            background-image: linear-gradient(45deg, #28a745 0%, #218838 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        #commitmentSection .modal-content button:hover {
            background-image: linear-gradient(45deg, #218838 0%, #1e7e34 100%);
        }

        /* New sections for initial flow */
        .full-screen-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e0f2f7 0%, #cce7f5 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        }
        .full-screen-section.show {
            opacity: 1;
            visibility: visible;
        }
        .full-screen-section .content-box {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            padding: 45px;
            max-width: 700px;
            width: 100%;
        }
        .full-screen-section h2 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 25px;
        }
        .full-screen-section p {
            font-size: 1.3rem;
            line-height: 1.8;
            color: #5d748f;
            margin-bottom: 30px;
        }
        .full-screen-section textarea {
            height: auto; /* Allow textarea to size content */
            min-height: 150px; /* Minimum height */
            resize: vertical; /* Allow vertical resize */
            direction: rtl; /* Ensure right-to-left for Arabic */
        }
    </style>
</head>
<body>
    <!-- Initial Name and Age Input Section -->
    <div id="nameAgeInputSection" class="full-screen-section">
        <div class="content-box">
            <h2>مرحباً بك في رحلة التغيير!</h2>
            <p>قبل أن نبدأ، من فضلك أدخل اسمك وعمرك لمساعدتنا في تقديم تجربة أفضل لك.</p>
            <input type="text" id="userNameInput" placeholder="اسمك الكريم" class="mb-4">
            <input type="number" id="userAgeInput" placeholder="عمرك (بالسنوات)" class="mb-6">
            <button onclick="submitUserInfo()">ابدأ الرحلة</button>
            <div id="nameAgeLoadingSpinner" class="loading-spinner"></div>
            <p id="nameValidationMessage" class="text-red-500 mt-4 hidden"></p>
        </div>
    </div>

    <!-- Dua Screen Section -->
    <div id="duaSection" class="full-screen-section">
        <div class="content-box">
            <h2>دعاء التوبة والاستغفار</h2>
            <p class="text-xl text-gray-800 leading-relaxed mb-8">
                اللهم أنت ربي لا إله إلا أنت خلقتني وأنا عبدك وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت وأبوء لك بنعمتك علي وأبوئ بذنبي فاغفر لي فأنه لا يغفر الذنوب إلا أنت، استغفر الله العظيم الذي لا إله إلا هو الحي القيوم وأتوب إليه توبة عبد ظالم لا يملك لنفسه ضرًا ولا نفعًا ولا موتًا ولا حياة ولا نشورًا.
            </p>
            <button onclick="proceedToCommitment()">لقد قرأت وأنا مستعد</button>
        </div>
    </div>

    <!-- Commitment Warning Section (Now a full-screen section too) -->
    <div id="commitmentSection" class="full-screen-section">
        <div class="content-box">
            <h3 class="text-3xl font-bold text-gray-800 mb-6">موقع جاد لرحلة التغيير</h3>
            <p id="commitmentMessage" class="text-lg text-gray-700 mb-8">
                أهلاً بك يا <span id="displayUserName">يا صديقي</span> في هذا الموقع. هذا المكان مصمم بجدية لمساعدتك في رحلتك نحو التغيير والتوبة. نرجو منك الدخول بنية صادقة والتعامل معه بمسؤولية كاملة.
            </p>
            <button onclick="acceptCommitment()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">أنا ملتزم وجاهز</button>
        </div>
    </div>

    <!-- Main Tracker Content (Initially hidden) -->
    <div class="container" id="mainTrackerApp" style="display: none;">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6">✨ تتبع رحلتك نحو التغيير الإيجابي ✨</h1>
        <p class="text-xl text-gray-700 mb-10">أدخل رقم اليوم الذي أنت فيه لتكتشف التغييرات والفوائد المذهلة التي ستلاحظها.</p>

        <input type="number" id="dayInput" placeholder="أدخل رقم اليوم هنا (مثال: 7)" class="mb-5">
        <button onclick="displayDayInfo()">اعرض لي التغييرات</button>
        <button onclick="showAiHelpModal()" class="mt-4 mr-2">أحتاج مساعدة فورية!</button>

        <div id="loadingSpinner" class="loading-spinner"></div>

        <div id="currentDayInfo" class="info-section">
            <h2>معلومات اليوم الحالي:</h2>
            <p id="currentDayText">أدخل رقم اليوم لمعرفة المعلومات الخاصة به.</p>
        </div>

        <div id="pastPeriodInfo" class="info-section">
            <h2>اليوم السابق والتالي:</h2>
            <p id="pastPeriodText">هنا ستظهر معلومات الأيام المحيطة باليوم المدخل.</p>
        </div>

        <!-- General Message Modal (used for warnings and errors) -->
        <div id="messageModal" class="modal">
            <div class="modal-content">
                <h3 id="modalTitle"></h3>
                <p id="modalMessage"></p>
                <button onclick="closeModal('messageModal')">حسناً، فهمت</button>
            </div>
        </div>

        <!-- AI Help Modal -->
        <div id="aiHelpModal" class="modal">
            <div class="modal-content">
                <h3>💡 مساعدة فورية من الذكاء الاصطناعي 💡</h3>
                <p class="text-lg text-gray-700 mb-6">إليك نصيحة سريعة لمساعدتك الآن:</p>

                <div id="currentAdviceDisplay" class="advice-display">
                    <!-- Advice will be displayed here -->
                </div>

                <div class="button-group">
                    <button id="nextAdviceButton" onclick="displayNextAdvice()">نصيحة أخرى</button>
                    <button id="revealAiChatButton" onclick="revealAiChat()">لم تفدني هذه النصائح، أحتاج لأتحدث مع الذكاء الاصطناعي</button>
                </div>

                <div id="aiQuestionSection" class="ai-question-section">
                    <p class="text-lg font-semibold mb-3">اكتب سؤالك هنا:</p>
                    <textarea id="aiQuestionInput" placeholder="اكتب سؤالك هنا..."></textarea>
                    <button onclick="askAiCustomQuestion()" class="mt-4">اسأل الذكاء الاصطناعي</button>
                    <div id="aiHelpLoadingSpinner" class="loading-spinner"></div>
                    <div id="aiResponseDisplay" class="ai-response mt-4 hidden"></div>
                    <div id="mathProblemDisplay" class="math-problem hidden"></div>
                </div>

                <button onclick="closeModal('aiHelpModal')" class="modal-close-button">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // Data mapping for benefits based on days
        const dayData = {
            1: "لا يوجد تغيير فوري.",
            2: "التفكير المستمر في المواد الإباحية.",
            4: "احتمال الإصابة بالمرض وقلة النوم.",
            5: "تقلبات المزاج والاكتئاب وزيادة الانتباه للفتيات.",
            6: "زيادة العصبية والتعب.",
            7: "زيادة مستويات الطاقة.",
            8: "زيادة الاستمتاع بالأشياء الصغيرة وتحسن الإنتاجية.",
            9: "ارتفاع مستويات هرمون التستوستيرون وهرمون النمو.",
            10: "انخفاض مستويات القلق والتوتر.",
            13: "تحسن مظهر الجلد.",
            14: "توقف الانتصاب الصباحي التلقائي.",
            15: "مشاعر الإحباط أحيانًا.",
            16: "النوم العميق وزيادة القدرة على الاسترخاء.",
            17: "تحسن العلاقات الاجتماعية.",
            18: "عدم القدرة على التركيز وزيادة التفكير في المواد الإباحية.",
            19: "زيادة الرغبة في العمل والثقة بالنفس.",
            20: "نمو العضلات وتقليل آلام المفاصل.",
            25: "اختفاء الإرهاق البدني وآلام المفاصل، وتحسن الذاكرة.",
            26: "زيادة الاحترام من الآخرين.",
            30: "نقطة المنتصف للتعافي، واستعادة القوة البدنية والطاقة.", // 1 month
            60: "تحسن جودة الحيوانات المنوية وزيادة فرص الحمل، وتحسن الانتصاب والتخلص من ضعف الانتصاب، وزيادة الإنتاجية واستخدام الدماغ.", // 2 months
            75: "يبدأ الناس في ملاحظة التغييرات الإيجابية.", // 2.5 months
            84: "تحسن الحياة الجنسية بين الشريكين.", // 2.8 months
            90: "رؤية أوضح للأهداف، وصوت أعمق.", // 3 months
            365: "تصبح المواد الإباحية نسبة صغيرة من العادات السابقة." // 1 year
        };

        // Predefined actions/answers
        const predefinedActions = {
            takeDeepBreaths: "خذ نفسًا عميقًا 5 مرات: ركز على شهيق وزفير بطيء لتغيير تركيزك وتحسين هدوئك. هذا يساعد على تهدئة الجهاز العصبي.",
            goForWalk: "اذهب للمشي الفوري أو اركض في مكانك لمدة 5 دقائق: الحركة السريعة كافية لتشتيت طاقتك وتحويل انتباهك. غير مكانك فورًا.",
            doPushups: "اعمل 10 ضغطات أو قفزات (Burpees): حول الطاقة الزائدة والرغبة لجهد بدني مكثف. الإرهاق الجسدي يقلل التفكير في الرغبة.",
            drinkWater: "اشرب كوب ماء كبير ببطء: اشعر بالانتعاش وغير شعورك الجسدي والنفسي. التركيز على عملية الشرب يشتت الانتباه.",
            playQuranOrPodcast: "شغل قرآن أو بودكاست تحفيزي بصوت عالٍ: ركز سمعك بالكامل على شيء إيجابي وملهم. غيّر الأجواء من حولك.",
            talkToFriend: "تحدث مع صديق تثق به أو أحد أفراد عائلتك: مجرد التحدث عن أي شيء (حتى لو مش عن الموضوع ده) بيكسر دايرة التفكير ويديك دعم.",
            performWudu: "قوم اتوضى بسرعة: تغيير الحالة الذهنية والجسدية والتركيز على العبادة بيساعد كثير على تهدئة النفس وتقوية الإرادة.",
            closeSource: "اقفل المصدر فورًا أو امسحه: لو لقيت حاجة حفزتك، ابعد عنها تمامًا وبدون تردد. إزالة المثيرات خطوة أساسية.",
            performPrayer: "صلي لو لسه ماصلتش فرض اليوم: التواصل مع ربنا بيقوي إرادتك ويمنحك السكينة والطمأنينة. الصلاة هي حصن لك.",
            solveMathProblem: "تُولد المسألة الرياضية بواسطة الذكاء الاصطناعي.", // Placeholder, actual problem generated by AI
            use54321: "استخدم تقنية 5-4-3-2-1 للتركيز: سمِّ 5 أشياء تراها، 4 تسمعها، 3 تشعر بها، 2 تشمها، 1 تتذوقها. ده بيرجعك للحظة الحالية ويشتت تفكيرك.",
            cleanArea: "نظّف شيئًا بسيطًا حولك: رتب مكتبك أو سريرك في دقيقتين. إنجاز بسيط بيغير مودك وبيحسسك بالسيطرة.",
            focusOnObject: "ركز على شيء ملموس حولك: أمسك قلمًا أو كوبًا، ولاحظ تفاصيله بدقة، ركز على ملمسه وشكله ووزنه. ده بيخلي عقلك يركز في حاجة مادية.",
            journaling: "دوّن في مذكرة صغيرة مشاعرك وأهدافك: اكتب اللي بتحس بيه وليه أنت بتعمل ده. التفريغ الكتابي بيساعد على فهم مشاعرك والتغلب عليها."
        };

        // DOM elements
        const nameAgeInputSection = document.getElementById('nameAgeInputSection');
        const userNameInput = document.getElementById('userNameInput');
        const userAgeInput = document.getElementById('userAgeInput');
        const nameAgeLoadingSpinner = document.getElementById('nameAgeLoadingSpinner');
        const nameValidationMessage = document.getElementById('nameValidationMessage');

        const duaSection = document.getElementById('duaSection');

        const commitmentSection = document.getElementById('commitmentSection'); // Now a section
        const displayUserName = document.getElementById('displayUserName'); // Span to display user name

        const mainTrackerApp = document.getElementById('mainTrackerApp'); // Main app container

        const dayInput = document.getElementById('dayInput');
        const currentDayInfoSection = document.getElementById('currentDayInfo');
        const currentDayText = document.getElementById('currentDayText');
        const pastPeriodInfoSection = document.getElementById('pastPeriodInfo');
        const pastPeriodText = document.getElementById('pastPeriodText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        const aiHelpModal = document.getElementById('aiHelpModal');
        const currentAdviceDisplay = document.getElementById('currentAdviceDisplay');
        const nextAdviceButton = document.getElementById('nextAdviceButton');
        const revealAiChatButton = document.getElementById('revealAiChatButton');
        const aiQuestionSection = document.getElementById('aiQuestionSection');
        const aiQuestionInput = document.getElementById('aiQuestionInput');
        const aiHelpLoadingSpinner = document.getElementById('aiHelpLoadingSpinner');
        const aiResponseDisplay = document.getElementById('aiResponseDisplay');
        const mathProblemDisplay = document.getElementById('mathProblemDisplay');

        // State for managing random advice display
        let availableAdviceKeys = [];
        let originalAdviceKeys = Object.keys(predefinedActions);

        // Global variables for tracking progress and user info
        let userName = localStorage.getItem('userName') || '';
        let userAge = parseInt(localStorage.getItem('userAge')) || 0;
        let firstEnteredDay = parseInt(localStorage.getItem('firstEnteredDay')) || 0;
        let trackedDayProgress = parseInt(localStorage.getItem('trackedDayProgress')) || 0;

        // --- Initial Flow Logic ---

        // New function for AI name validation
        async function validateNameWithAI(nameToValidate) {
            try {
                const isValid = await getAiInformation(nameToValidate, "nameValidation");
                return isValid;
            } catch (error) {
                console.error("Error validating name with AI:", error);
                return false; // Assume invalid if AI call fails
            }
        }

        // Functions for initial flow
        function showNameAgeInput() {
            nameAgeInputSection.classList.add('show');
        }

        async function submitUserInfo() {
            const name = userNameInput.value.trim();
            const age = parseInt(userAgeInput.value);

            if (!name || isNaN(age) || age <= 0) {
                nameValidationMessage.textContent = 'من فضلك أدخل اسمًا وعمرًا صحيحين.';
                nameValidationMessage.classList.remove('hidden');
                return;
            }

            nameAgeLoadingSpinner.style.display = 'block';
            nameValidationMessage.classList.add('hidden');

            const isNameValid = await validateNameWithAI(name);

            nameAgeLoadingSpinner.style.display = 'none';

            if (!isNameValid) {
                nameValidationMessage.textContent = 'الاسم المدخل لا يبدو اسمًا حقيقيًا. من فضلك أدخل اسمًا مناسبًا لهذه الرحلة الجادة.';
                nameValidationMessage.classList.remove('hidden');
                return;
            }

            userName = name;
            userAge = age;
            localStorage.setItem('userName', userName);
            localStorage.setItem('userAge', userAge);

            nameAgeInputSection.classList.remove('show');
            showDuaSection();
        }

        function showDuaSection() {
            duaSection.classList.add('show');
        }

        function proceedToCommitment() {
            duaSection.classList.remove('show');
            showCommitmentSection();
        }

        function showCommitmentSection() {
            displayUserName.textContent = userName; // Set the user's name
            commitmentSection.classList.add('show');
        }

        function acceptCommitment() {
            localStorage.setItem('warningShown', 'true');
            commitmentSection.classList.remove('show');
            mainTrackerApp.style.display = 'block';
            // Set initial message for main app
            if (trackedDayProgress === 0) {
                currentDayText.textContent = `أهلاً بك ${userName} في رحلتك! أدخل أول يوم لتبدأ التتبع.`;
                pastPeriodText.textContent = '';
            } else {
                // If they already accepted before and just cleared localStorage, load their last progress
                dayInput.value = trackedDayProgress;
                displayDayInfo();
            }
        }
        // --- End Initial Flow Logic ---

        window.addEventListener('load', () => {
            if (userName && userAge && localStorage.getItem('warningShown')) {
                mainTrackerApp.style.display = 'block';
                if (trackedDayProgress > 0) {
                     dayInput.value = trackedDayProgress;
                     displayDayInfo();
                } else {
                    currentDayText.textContent = `أهلاً بك ${userName} في رحلتك! أدخل أول يوم لتبدأ التتبع.`;
                    pastPeriodText.textContent = '';
                }
            } else if (userName && userAge) {
                showCommitmentSection();
            } else {
                showNameAgeInput();
            }
        });


        // Function to show general message modal
        function showModal(modalId, title = '', message = '') {
            const modal = document.getElementById(modalId);
            if (modalId === 'messageModal') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
            }
            modal.classList.add('show');
        }

        // Function to close any modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            if (modalId === 'aiHelpModal') {
                aiQuestionInput.value = '';
                aiResponseDisplay.textContent = '';
                aiResponseDisplay.classList.add('hidden');
                mathProblemDisplay.textContent = '';
                mathProblemDisplay.classList.add('hidden');
                aiHelpLoadingSpinner.style.display = 'none';
                aiResponseDisplay.style.color = '#5d748f';
                aiResponseDisplay.style.borderColor = '#b3e0ff';
                aiQuestionSection.classList.remove('show');
                currentAdviceDisplay.classList.remove('hidden');
            }
        }

        // Function to animate info sections (main tracker)
        function animateInfoSection(element) {
            element.classList.remove('loaded');
            void element.offsetWidth;
            element.classList.add('loaded');
        }

        async function displayDayInfo() {
            const rawDayInput = dayInput.value;
            const dayNumber = parseInt(rawDayInput);

            currentDayInfoSection.classList.remove('loaded');
            pastPeriodInfoSection.classList.remove('loaded');
            currentDayText.textContent = 'أدخل رقم اليوم لمعرفة المعلومات الخاصة به.';
            pastPeriodText.textContent = 'هنا ستظهر معلومات الأيام المحيطة باليوم المدخل.';

            if (isNaN(dayNumber) || dayNumber <= 0) {
                showModal('messageModal', 'خطأ في الإدخال', 'من فضلك أدخل رقم يوم صحيح وموجب.');
                return;
            }

            // Logic to handle user progress and "cheating" detection
            if (firstEnteredDay === 0) {
                firstEnteredDay = dayNumber;
                trackedDayProgress = dayNumber;
                localStorage.setItem('firstEnteredDay', firstEnteredDay);
                localStorage.setItem('trackedDayProgress', trackedDayProgress);
                displaySpecificDaysInfo(dayNumber);
            } else {
                if (dayNumber > trackedDayProgress + 1 && dayNumber > firstEnteredDay + 1) { // More strict check for jumping ahead
                    showModal('messageModal', 'تنبيه جاد!', `أنت تحاول القفز في الأيام يا ${userName}. هذا الموقع جاد وليس للهزار. أنت حاليًا تتبع التقدم حتى اليوم رقم ${trackedDayProgress}. من فضلك أدخل اليوم التالي الصحيح (${trackedDayProgress + 1}) أو يوم سابق.`);
                    dayInput.value = trackedDayProgress;
                    displaySpecificDaysInfo(trackedDayProgress);
                    return;
                } else if (dayNumber === trackedDayProgress + 1) {
                    trackedDayProgress = dayNumber;
                    localStorage.setItem('trackedDayProgress', trackedDayProgress);
                    displaySpecificDaysInfo(dayNumber);
                } else if (dayNumber <= trackedDayProgress || (dayNumber >= firstEnteredDay && dayNumber <= trackedDayProgress + 1)) {
                    // Allows reviewing past days or progressing normally to the next day
                    displaySpecificDaysInfo(dayNumber);
                } else { // Handle cases where they go back drastically but not to an invalid day
                     showModal('messageModal', 'تنبيه!', `يبدو أنك تحاول العودة لأيام بعيدة يا ${userName}. هذا الموقع لتتبع التقدم. من فضلك أدخل اليوم التالي (${trackedDayProgress + 1}) أو راجع يومًا قريبًا.`);
                     dayInput.value = trackedDayProgress; // Reset input to the valid tracked day
                     displaySpecificDaysInfo(trackedDayProgress); // Show info for the *tracked* day
                     return;
                }
            }
        }

        async function displaySpecificDaysInfo(centralDay) {
            // Display info for centralDay
            let currentDayBenefit = dayData[centralDay];
            if (!currentDayBenefit) {
                currentDayText.textContent = `جاري البحث عن معلومات لليوم ${centralDay}...`;
                loadingSpinner.style.display = 'block';
                currentDayBenefit = await getAiInformation(centralDay, "dayInfo");
                loadingSpinner.style.display = 'none';
            }
            currentDayText.innerHTML = `<strong>اليوم ${centralDay}:</strong> ${currentDayBenefit}`;
            animateInfoSection(currentDayInfoSection);

            let surroundingDaysInfo = '';
            const dayBefore = centralDay - 1;
            const dayAfter = centralDay + 1;

            if (dayBefore >= 1) {
                let benefitBefore = dayData[dayBefore];
                if (!benefitBefore) {
                    benefitBefore = await getAiInformation(dayBefore, "dayInfo");
                }
                surroundingDaysInfo += `<p class="mb-2"><strong>اليوم ${dayBefore} (السابق):</strong> ${benefitBefore}</p>`;
            } else {
                surroundingDaysInfo += `<p class="mb-2"><strong>اليوم السابق:</strong> لا توجد معلومات متاحة (قبل بدء الرحلة).</p>`;
            }

            let benefitAfter = dayData[dayAfter];
            if (!benefitAfter) {
                benefitAfter = await getAiInformation(dayAfter, "dayInfo");
            }
            surroundingDaysInfo += `<p class="mb-2"><strong>اليوم ${dayAfter} (التالي):</strong> ${benefitAfter}</p>`;

            pastPeriodText.innerHTML = surroundingDaysInfo;
            animateInfoSection(pastPeriodInfoSection);
        }

        // Function to show AI Help Modal
        function showAiHelpModal() {
            showModal('aiHelpModal');
            availableAdviceKeys = [...originalAdviceKeys];
            shuffleArray(availableAdviceKeys);
            currentAdviceDisplay.classList.remove('show-advice');
            displayNextAdvice();
            aiQuestionSection.classList.remove('show');
            nextAdviceButton.style.display = 'inline-block';
            revealAiChatButton.style.display = 'inline-block';
            aiResponseDisplay.classList.add('hidden');
            mathProblemDisplay.classList.add('hidden');
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Display the next random advice
        async function displayNextAdvice() {
            currentAdviceDisplay.classList.remove('show-advice');
            currentAdviceDisplay.classList.remove('hidden');
            aiResponseDisplay.classList.add('hidden');
            mathProblemDisplay.classList.add('hidden');

            if (availableAdviceKeys.length === 0) {
                availableAdviceKeys = [...originalAdviceKeys];
                shuffleArray(availableAdviceKeys);
                currentAdviceDisplay.textContent = 'لقد رأيت جميع النصائح! سأعيد عرضها لك مرة أخرى.';
                setTimeout(() => { currentAdviceDisplay.classList.add('show-advice'); }, 100);
                return;
            }

            const randomKey = availableAdviceKeys.pop();
            const adviceText = predefinedActions[randomKey];

            if (randomKey === 'solveMathProblem') {
                currentAdviceDisplay.textContent = 'جاري توليد المسألة الرياضية...';
                aiHelpLoadingSpinner.style.display = 'block';
                try {
                    await getAiInformation('generate_math_problem', 'mathProblem');
                    currentAdviceDisplay.textContent = 'ركز في هذه المسألة:';
                } finally {
                    aiHelpLoadingSpinner.style.display = 'none';
                }
            } else {
                currentAdviceDisplay.textContent = adviceText;
            }
            setTimeout(() => { currentAdviceDisplay.classList.add('show-advice'); }, 100);
        }

        // Reveal the AI chat section
        function revealAiChat() {
            aiQuestionSection.classList.add('show');
            nextAdviceButton.style.display = 'none';
            revealAiChatButton.style.display = 'none';
            currentAdviceDisplay.classList.add('hidden');
            aiQuestionInput.value = '';
            aiResponseDisplay.textContent = '';
            aiResponseDisplay.classList.add('hidden');
            mathProblemDisplay.classList.add('hidden');
        }

        // Function to ask AI a custom question
        async function askAiCustomQuestion() {
            const question = aiQuestionInput.value.trim();
            if (!question) {
                aiResponseDisplay.classList.remove('hidden');
                aiResponseDisplay.textContent = 'من فضلك أدخل سؤالك أولاً.';
                aiResponseDisplay.style.color = '#ef5350';
                aiResponseDisplay.style.borderColor = '#ef5350';
                mathProblemDisplay.classList.add('hidden');
                return;
            }

            aiResponseDisplay.classList.remove('hidden');
            aiResponseDisplay.textContent = 'جاري التفكير...';
            aiResponseDisplay.style.color = '#5d748f';
            aiResponseDisplay.style.borderColor = '#b3e0ff';
            aiHelpLoadingSpinner.style.display = 'block';
            mathProblemDisplay.classList.add('hidden');

            try {
                await getAiInformation(question, "aiHelp");
            } finally {
                aiHelpLoadingSpinner.style.display = 'none';
            }
        }

        // AI Information Retrieval Function
        async function getAiInformation(query, type) {
            let prompt = "";
            const generalContext = `أنت مساعد متخصص في تقديم الدعم والنصائح العملية والموجزة جدًا والمباشرة المتعلقة بالتوقف عن العادات الضارة وإدارة الرغبات. اسم المستخدم هو ${userName} وعمره ${userAge} عامًا. لا تعلق على عمر المستخدم. مهمتك هي الإجابة على الأسئلة المتعلقة بهذا الموضوع فقط. يجب أن تكون إجاباتك إيجابية، مشجعة، وعملية، ومختصرة جدًا ومباشرة. إذا كان السؤال خارج هذا الإطار، اعتذر بلطف ووضح أنك لا تستطيع الإجابة. في حالة طلب مسألة رياضية، قم بتوليد مسألة ضرب رقم في رقمين، مثل 9 × 76، وتقديم الحل معها. يجب أن تكون الأرقام عشوائية ومعقولة لتكون تحديًا بسيطًا. مثلاً: 'المسألة: 42 × 7 = ؟ الحل: 294'`;

            if (type === "dayInfo") {
                const dayNumber = query;
                prompt = `${generalContext}\n\nيرجى تلخيص ما يمكن أن يحدث في اليوم رقم ${dayNumber} من التوقف عن عادة معينة، مع الأخذ في الاعتبار النمط العام للتغيرات خلال هذه الرحلة الطويلة واستخدام البيانات المتاحة. اجعل الإجابة موجزة ومباشرة.`;
            } else if (type === "aiHelp") {
                const userQuestion = query;
                prompt = `${generalContext}\n\nسؤال المستخدم: "${userQuestion}". هل هذا السؤال يتعلق بموضوع التوقف عن العادات وإدارة الرغبات؟ إذا كان كذلك، أجب عليه بإجابة عملية ومختصرة جدًا. إذا لم يكن كذلك، أجب "أعتذر، سؤالي يخرج عن نطاق تخصصي في مساعدة التوقف عن العادات. يرجى طرح سؤال متعلق بالموضوع."`;
            } else if (type === "mathProblem") {
                prompt = `${generalContext}\n\nيرجى توليد مسألة ضرب رقم في رقمين، مثل 9 × 76، وتقديم الحل معها. يجب أن تكون الأرقام عشوائية (وليس ثابتة مثل 9 أو 76) ومعقولة لتكون تحديًا بسيطًا. مثلاً: "المسألة: 42 × 7 = ؟ الحل: 294"`;
            } else if (type === "nameValidation") {
                const nameToValidate = query;
                prompt = `هل الاسم "${nameToValidate}" يبدو اسمًا بشريًا عربيًا تقليديًا أو شائعًا، أم يبدو عشوائيًا أو غير منطقي (مثل "asdfghjkl" أو "123")؟ أجب بكلمة واحدة فقط: "حقيقي" إذا كان يبدو اسمًا بشريًا، أو "غير حقيقي" إذا كان يبدو عشوائيًا أو غير منطقي.`;
            }

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];

                const payload = {
                    contents: chatHistory,
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    ]
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiText = result.candidates[0].content.parts[0].text.trim();

                    if (type === "dayInfo") {
                        return aiText;
                    } else if (type === "aiHelp") {
                        aiResponseDisplay.textContent = aiText;
                        aiResponseDisplay.style.color = (aiText.includes("أعتذر، سؤالي يخرج عن نطاق تخصصي") || aiText.includes("لا أستطيع الإجابة")) ? '#ef5350' : '#388e3c';
                        aiResponseDisplay.style.borderColor = (aiText.includes("أعتذر، سؤالي يخرج عن نطاق تخصصي") || aiText.includes("لا أستطيع الإجابة")) ? '#ef5350' : '#c8e6c9';
                        mathProblemDisplay.classList.add('hidden');
                        return aiText;
                    } else if (type === "mathProblem") {
                        const problemMatch = aiText.match(/المسألة:\s*(.*?)\s*الحل:\s*(.*)/i);
                        if (problemMatch && problemMatch.length >= 3) {
                            const problem = problemMatch[1].trim();
                            const answer = problemMatch[2].trim();
                            mathProblemDisplay.textContent = `المسألة: ${problem}\nفكر في حلها! (الحل: ${answer})`;
                            mathProblemDisplay.classList.remove('hidden');
                            currentAdviceDisplay.classList.add('hidden');
                        } else {
                            mathProblemDisplay.textContent = `عذراً، حدث خطأ في توليد المسألة. حاول مرة أخرى.`;
                            mathProblemDisplay.classList.remove('hidden');
                            currentAdviceDisplay.classList.add('hidden');
                        }
                        return aiText;
                    } else if (type === "nameValidation") {
                        return aiText === "حقيقي";
                    }
                } else {
                    const fallbackMessage = 'عذراً، لم أتمكن من الحصول على إجابة حالياً. قد يكون المحتوى غير مناسب أو حدث خطأ. يرجى المحاولة مرة أخرى.';
                    if (type === "dayInfo") {
                        return fallbackMessage;
                    } else if (type === "aiHelp") {
                        aiResponseDisplay.textContent = fallbackMessage;
                        aiResponseDisplay.style.color = '#ef5350';
                        aiResponseDisplay.style.borderColor = '#ef5350';
                    } else if (type === "mathProblem") {
                        mathProblemDisplay.textContent = fallbackMessage;
                        mathProblemDisplay.classList.remove('hidden');
                    } else if (type === "nameValidation") {
                        console.warn("AI failed to validate name, assuming it's not real.");
                        return false;
                    }
                    return fallbackMessage;
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                const errorMessage = 'حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.';
                if (type === "dayInfo") {
                    return errorMessage;
                } else if (type === "aiHelp") {
                    aiResponseDisplay.textContent = errorMessage;
                    aiResponseDisplay.style.color = '#ef5350';
                    aiResponseDisplay.style.borderColor = '#ef5350';
                } else if (type === "mathProblem") {
                    mathProblemDisplay.textContent = errorMessage;
                    mathProblemDisplay.classList.remove('hidden');
                } else if (type === "nameValidation") {
                    console.error("Error during name validation AI call:", error);
                    return false;
                }
                return errorMessage;
            }
        }
    </script>
</body>
</html>
